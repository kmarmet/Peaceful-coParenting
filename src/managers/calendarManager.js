// Generated by CoffeeScript 2.7.0
var CalendarManager;

import DB from "@db";

import "../prototypes";

import {
  child,
  getDatabase,
  ref,
  remove,
  set
} from 'firebase/database';

import Manager from "./manager";

import {
  formatFileName,
  formatNameFirstNameOnly,
  formatTitleWords,
  getFirstWord,
  isAllUppercase,
  removeFileExtension,
  removeSpacesAndLowerCase,
  spaceBetweenWords,
  stringHasNumbers,
  toCamelCase,
  uppercaseFirstLetterOfAllWords,
  wordCount
} from "../globalFunctions";

import LogManager from "./logManager";

export default CalendarManager = {
  formatEventTitle: function(title) {
    if (title && title.length > 0) {
      title = uppercaseFirstLetterOfAllWords(title);
      title = formatTitleWords(title);
      return title;
    }
  },
  addMultipleCalEvents: async function(currentUser, newEvents) {
    var currentEvents, dbRef, error, eventsAreShared, eventsOrSharedEvents, eventsWithShareWith, toAdd;
    eventsAreShared = false;
    eventsWithShareWith = newEvents.filter(function(x) {
      return Manager.isValid(x.shareWith);
    });
    if (eventsWithShareWith.length > 0) {
      eventsAreShared = true;
    }
    eventsOrSharedEvents = eventsAreShared ? "sharedEvents" : "events";
    dbRef = ref(getDatabase());
    currentEvents = (await DB.getTable(`${DB.tables.calendarEvents}/${currentUser.phone}/${eventsOrSharedEvents}`));
    console.log(currentEvents);
    console.log(newEvents);
    toAdd = [...currentEvents, ...newEvents];
    try {
      return (await set(child(dbRef, `${DB.tables.calendarEvents}/${currentUser.phone}/${eventsOrSharedEvents}`), toAdd));
    } catch (error1) {
      error = error1;
      return LogManager.log(error.message, LogManager.logTypes.error, error.stack);
    }
  },
  setHolidays: async function(holidays) {
    var currentEvents, dbRef, error, eventsToAdd;
    dbRef = ref(getDatabase());
    currentEvents = (await DB.getTable(DB.tables.calendarEvents));
    eventsToAdd = [...currentEvents, ...holidays].filter(function(x) {
      return x != null;
    }).flat();
    try {
      return (await set(child(dbRef, `${DB.tables.calendarEvents}`), eventsToAdd));
    } catch (error1) {
      error = error1;
      return LogManager.log(error.message, LogManager.logTypes.error, error.stack);
    }
  },
  addCalendarEvent: async function(currentUser, newEvent) {
    var currentEvents, dbRef, error, toAdd;
    dbRef = ref(getDatabase());
    currentEvents = (await DB.getTable(`${DB.tables.calendarEvents}/${currentUser.phone}/events`));
    currentEvents = currentEvents.filter(function(n) {
      return n;
    });
    toAdd = [];
    try {
      if (Manager.isValid(currentEvents)) {
        toAdd = [...currentEvents, newEvent];
      } else {
        toAdd = [newEvent];
      }
      return set(child(dbRef, `${DB.tables.calendarEvents}/${currentUser.phone}/events`), toAdd);
    } catch (error1) {
      error = error1;
      return LogManager.log(error.message, LogManager.logTypes.error, error.stack);
    }
  },
  addSharedEvent: async function(currentUser, newEvent) {
    var currentEvents, dbRef, error;
    dbRef = ref(getDatabase());
    currentEvents = Manager.convertToArray((await DB.getTable(`${DB.tables.calendarEvents}/${currentUser.phone}/sharedEvents`)));
    currentEvents = currentEvents.filter(function(n) {
      return n;
    });
    try {
      return set(child(dbRef, `${DB.tables.calendarEvents}/${currentUser.phone}/sharedEvents`), [...currentEvents, newEvent]);
    } catch (error1) {
      error = error1;
      return LogManager.log(error.message, LogManager.logTypes.error, error.stack);
    }
  },
  deleteMultipleEvents: async function(events, currentUser, eventParentName = "events") {
    var dbRef, i, idToDelete, len, record, results, tableRecords;
    console.log(`${DB.tables.calendarEvents}/${currentUser.phone}/${eventParentName}`);
    dbRef = ref(getDatabase());
    tableRecords = (await DB.getTable(`${DB.tables.calendarEvents}/${currentUser.phone}/${eventParentName}`));
    results = [];
    for (i = 0, len = tableRecords.length; i < len; i++) {
      record = tableRecords[i];
      idToDelete = (await DB.getSnapshotKey(`${DB.tables.calendarEvents}/${currentUser.phone}/${eventParentName}`, record, 'id'));
      results.push((await remove(child(dbRef, `${DB.tables.calendarEvents}/${currentUser.phone}/${eventParentName}/${idToDelete}`))));
    }
    return results;
  },
  deleteEvent: async function(currentUser, eventParentName = "events", id) {
    var dbRef, error, i, idToDelete, len, record, results, tableRecords;
    dbRef = ref(getDatabase());
    idToDelete = null;
    tableRecords = (await DB.getTable(`${DB.tables.calendarEvents}/${currentUser.phone}/${eventParentName}`));
    results = [];
    for (i = 0, len = tableRecords.length; i < len; i++) {
      record = tableRecords[i];
      if ((record != null ? record.id : void 0) === id) {
        idToDelete = (await DB.getSnapshotKey(`${DB.tables.calendarEvents}/${currentUser.phone}/${eventParentName}`, record, 'id'));
        try {
          results.push(remove(child(dbRef, `${DB.tables.calendarEvents}/${currentUser.phone}/${eventParentName}/${idToDelete}`)));
        } catch (error1) {
          error = error1;
          results.push(LogManager.log(error.message, LogManager.logTypes.error, error.stack));
        }
      } else {
        results.push(void 0);
      }
    }
    return results;
  }
};

//# sourceMappingURL=calendarManager.js.map

// Generated by CoffeeScript 2.7.0
var SecurityManager,
  indexOf = [].indexOf;

import Manager from '../managers/manager';

import DB from "../database/DB";

import DateManager from "../managers/dateManager";

import _ from "lodash";

import DB_UserScoped from "../database/DB_UserScoped";

SecurityManager = {
  getShareWithItems: async function(currentUser, table) {
    var coparent, coparentAndChildEvents, coparentItems, i, item, j, len, len1, ref, ref1;
    coparentAndChildEvents = [];
    if (Manager.isValid(currentUser) && Manager.isValid(currentUser != null ? currentUser.coparents : void 0)) {
      ref = currentUser != null ? currentUser.coparents : void 0;
      for (i = 0, len = ref.length; i < len; i++) {
        coparent = ref[i];
        coparentItems = (await DB.getTable(`${table}/${coparent != null ? coparent.key : void 0}`));
        for (j = 0, len1 = coparentItems.length; j < len1; j++) {
          item = coparentItems[j];
          if (Manager.isValid(item != null ? item.shareWith : void 0)) {
            if (item != null ? (ref1 = item.shareWith) != null ? ref1.includes(currentUser != null ? currentUser.key : void 0) : void 0 : void 0) {
              coparentAndChildEvents.push(item);
            }
          }
        }
      }
    }
    coparentAndChildEvents = _.flattenDeep(coparentAndChildEvents);
    return coparentAndChildEvents;
  },
  getCalendarEvents: async function(currentUser) {
    var allEvents, event, i, len, returnRecords, sharedEvents, users;
    users = (await DB.getTable(DB.tables.users));
    currentUser = users.find(function(x) {
      return x.email === (currentUser != null ? currentUser.email : void 0);
    });
    returnRecords = [];
    allEvents = (await DB.getTable(`${DB.tables.calendarEvents}/${currentUser != null ? currentUser.key : void 0}`));
    sharedEvents = (await SecurityManager.getShareWithItems(currentUser, DB.tables.calendarEvents));
    if (Manager.isValid(allEvents)) {
      for (i = 0, len = allEvents.length; i < len; i++) {
        event = allEvents[i];
        if (DateManager.isValidDate(event.startDate)) {
          if (event.ownerKey === (currentUser != null ? currentUser.key : void 0)) {
            returnRecords.push(event);
          }
        }
      }
    }
    if (Manager.isValid(sharedEvents)) {
      returnRecords = [...sharedEvents, ...returnRecords];
    }
    return returnRecords;
  },
  getUserVisitationHolidays: async function(currentUser) {
    var allEvents, event, i, len, returnRecords, sharedEvents;
    returnRecords = [];
    allEvents = (await DB.getTable(`${DB.tables.calendarEvents}/${currentUser != null ? currentUser.key : void 0}`));
    sharedEvents = (await SecurityManager.getShareWithItems(currentUser, DB.tables.calendarEvents));
    if (Manager.isValid(allEvents)) {
      for (i = 0, len = allEvents.length; i < len; i++) {
        event = allEvents[i];
        if (DateManager.isValidDate(event.startDate)) {
          if (event.ownerKey === (currentUser != null ? currentUser.key : void 0)) {
            returnRecords.push(event);
          }
        }
      }
    }
    if (Manager.isValid(sharedEvents)) {
      returnRecords = [...sharedEvents, ...returnRecords];
    }
    return returnRecords;
  },
  getExpenses: async function(currentUser) {
    var allExpenses, expense, i, len, returnRecords, sharedExpenses;
    returnRecords = [];
    allExpenses = Manager.convertToArray((await DB.getTable(`${DB.tables.expenses}/${currentUser != null ? currentUser.key : void 0}`))).flat();
    sharedExpenses = (await SecurityManager.getShareWithItems(currentUser, DB.tables.expenses));
    if (Manager.isValid(allExpenses)) {
      for (i = 0, len = allExpenses.length; i < len; i++) {
        expense = allExpenses[i];
        if (expense.ownerKey === (currentUser != null ? currentUser.key : void 0)) {
          returnRecords.push(expense);
        }
      }
    }
    if (Manager.isValid(sharedExpenses)) {
      returnRecords = [...sharedExpenses, ...returnRecords];
    }
    return returnRecords;
  },
  getSwapRequests: async function(currentUser) {
    var allRequests, i, len, request, returnRecords, sharedSwaps;
    returnRecords = [];
    allRequests = Manager.convertToArray((await DB.getTable(`${DB.tables.swapRequests}/${currentUser.phone}`))).flat();
    sharedSwaps = (await SecurityManager.getShareWithItems(currentUser, DB.tables.swapRequests));
    if (Manager.isValid(allRequests)) {
      for (i = 0, len = allRequests.length; i < len; i++) {
        request = allRequests[i];
        if (request.ownerKey === (currentUser != null ? currentUser.key : void 0)) {
          returnRecords.push(request);
        }
      }
    }
    if (Manager.isValid(sharedSwaps)) {
      returnRecords = [...sharedSwaps, ...returnRecords];
    }
    return returnRecords;
  },
  getTransferChangeRequests: async function(currentUser) {
    var allRequests, i, len, request, returnRecords, sharedTransfers;
    returnRecords = [];
    allRequests = Manager.convertToArray((await DB.getTable(`${DB.tables.transferChangeRequests}/${currentUser.phone}`))).flat();
    sharedTransfers = (await SecurityManager.getShareWithItems(currentUser, DB.tables.swapRequests));
    if (Manager.isValid(allRequests)) {
      for (i = 0, len = allRequests.length; i < len; i++) {
        request = allRequests[i];
        if (request.ownerKey === (currentUser != null ? currentUser.key : void 0)) {
          returnRecords.push(request);
        }
      }
    }
    if (Manager.isValid(sharedTransfers)) {
      returnRecords = [...sharedTransfers, ...returnRecords];
    }
    return returnRecords.flat();
  },
  getDocuments: async function(currentUser) {
    var allDocs, doc, i, len, returnRecords, sharedDocs;
    returnRecords = [];
    allDocs = Manager.convertToArray((await DB.getTable(`${DB.tables.documents}/${currentUser.phone}`))).flat();
    sharedDocs = (await SecurityManager.getShareWithItems(currentUser, DB.tables.documents));
    if (Manager.isValid(allDocs)) {
      for (i = 0, len = allDocs.length; i < len; i++) {
        doc = allDocs[i];
        if (doc.ownerKey === (currentUser != null ? currentUser.key : void 0)) {
          returnRecords.push(doc);
        }
      }
    }
    if (Manager.isValid(sharedDocs)) {
      returnRecords = [...sharedDocs, ...returnRecords];
    }
    return returnRecords.flat();
  },
  getMemories: async function(currentUser) {
    var allMemories, i, len, memory, returnRecords, sharedMemories;
    returnRecords = [];
    allMemories = Manager.convertToArray((await DB.getTable(`${DB.tables.memories}/${currentUser != null ? currentUser.key : void 0}`))).flat();
    sharedMemories = (await SecurityManager.getShareWithItems(currentUser, DB.tables.swapRequests));
    if (Manager.isValid(allMemories)) {
      for (i = 0, len = allMemories.length; i < len; i++) {
        memory = allMemories[i];
        if (memory.ownerKey === (currentUser != null ? currentUser.key : void 0)) {
          returnRecords.push(memory);
        }
      }
    }
    if (Manager.isValid(sharedMemories)) {
      returnRecords = [...sharedMemories, ...returnRecords];
    }
    return returnRecords.flat();
  },
  getArchivedChats: async function(currentUser) {
    var allArchivedChats, chat, chatArray, i, j, len, len1, returnRecords;
    returnRecords = [];
    allArchivedChats = Manager.convertToArray((await DB.getTable(`${DB.tables.archivedChats}`))).flat();
    if (Manager.isValid(allArchivedChats, true)) {
      for (i = 0, len = allArchivedChats.length; i < len; i++) {
        chatArray = allArchivedChats[i];
        for (j = 0, len1 = chatArray.length; j < len1; j++) {
          chat = chatArray[j];
          if (chat.ownerKey === (currentUser != null ? currentUser.key : void 0)) {
            returnRecords.push(chat);
          }
        }
      }
    }
    return returnRecords.flat();
  },
  getInputSuggestions: async function(currentUser) {
    var i, len, returnRecords, suggestion, suggestions;
    returnRecords = [];
    suggestions = Manager.convertToArray((await DB.getTable(DB.tables.suggestions))).flat();
    if (Manager.isValid(suggestions)) {
      for (i = 0, len = suggestions.length; i < len; i++) {
        suggestion = suggestions[i];
        if (suggestion.ownerKey === (currentUser != null ? currentUser.key : void 0)) {
          returnRecords.push(suggestion);
        }
      }
    }
    return returnRecords.flat();
  },
  getChats: async function(currentUser) {
    var chat, chats, i, len, members, ref, ref1, securedChats;
    chats = Manager.convertToArray((await DB.getTable(`${DB.tables.chats}/${currentUser != null ? currentUser.key : void 0}`))).flat();
    securedChats = [];
    // User does not have a chat with root access by phone
    if (Manager.isValid(chats)) {
      for (i = 0, len = chats.length; i < len; i++) {
        chat = chats[i];
        members = chat != null ? (ref = chat.members) != null ? ref.map(function(x) {
          return x.phone;
        }) : void 0 : void 0;
        if (ref1 = currentUser != null ? currentUser.key : void 0, indexOf.call(members, ref1) >= 0) {
          securedChats.push(chat);
        }
      }
    }
    return securedChats.flat();
  },
  getCoparentChats: async function(currentUser) {
    var activeChats, allChats, allChatsFlattened, chat, i, len, members, ref;
    allChats = (await DB.getTable('chats'));
    activeChats = [];
    allChatsFlattened = allChats.flat();
    if (Manager.isValid(allChatsFlattened)) {
      for (i = 0, len = allChatsFlattened.length; i < len; i++) {
        chat = allChatsFlattened[i];
        members = chat.members.map(function(x) {
          return x.phone;
        });
        if (ref = currentUser != null ? currentUser.key : void 0, indexOf.call(members, ref) >= 0) {
          activeChats.push(chat);
        }
      }
    }
    return activeChats;
  }
};

export default SecurityManager;
